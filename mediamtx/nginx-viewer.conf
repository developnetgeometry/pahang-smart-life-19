server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;


  # Correct MIME types so Chrome doesn't sniff into HTML (avoids ORB)
  types {
    application/vnd.apple.mpegurl m3u8;
    video/mp2t ts;
    image/jpeg jpg jpeg;
    multipart/x-mixed-replace mjpg;
  }

  location / {
    try_files $uri /index.html;
    add_header X-Content-Type-Options nosniff always;
    # Helps auto-fix stray http references:
    add_header Content-Security-Policy "upgrade-insecure-requests" always;
  }

  # HLS and MJPEG proxy to MediaMTX
  location /hls/ {
    proxy_pass http://mediamtx:8888/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header Connection "";
    proxy_buffering off;              # low latency
    sendfile on;

    # Don't forward upstream CORS headers; we set our own to avoid duplicates
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Credentials;

    # Our CORS policy
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Range, Accept, Referer, User-Agent, Content-Type, Authorization, ngrok-skip-browser-warning" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range, Accept-Ranges" always;
    add_header Cross-Origin-Resource-Policy cross-origin always;
    add_header Vary Origin always;
    add_header X-Content-Type-Options nosniff always;

    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Origin, Range, Accept, Referer, User-Agent, Content-Type, Authorization, ngrok-skip-browser-warning" always;
      add_header Access-Control-Max-Age 1728000 always;
      return 204;
    }
  }
}

